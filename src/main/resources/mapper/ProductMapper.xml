<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yosep.myweb.product.service.ProductMapper">
    <select id="getProductList" resultType="ProductDTO" parameterType="map">
        SELECT 
            P.PROD_ID     AS prodId,
            P.CATE_CODE   AS cateCode,
            P.PROD_NAME   AS prodName,
            P.PROD_PRICE  AS prodPrice,
            P.FILE_NAME   AS fileName,
            P.IMAGE_URL   AS imageUrl,
            P.STOCK_COUNT AS stockCount,
            P.WISH_COUNT  AS wishCount,  D.DETAIL_NAME AS cateName,
            (SELECT COUNT(*) 
            FROM WISHLIST W 
            WHERE W.PROD_ID = P.PROD_ID 
            AND W.USER_ID = #{userId}) AS isWished
        FROM PRODUCT_MASTER P
        INNER JOIN CODE_DETAIL D ON P.CATE_CODE = D.DETAIL_CODE
        INNER JOIN CODE_MASTER M ON D.MASTER_CODE = M.MASTER_CODE
        <where>
            AND M.MASTER_CODE = 'PROD_CATEGORY'
            AND M.USE_YN = 'Y'
            AND D.USE_YN = 'Y'
            AND P.USE_YN = 'Y'
            
            <if test="cateCode != null and cateCode != ''">
                AND P.CATE_CODE = #{cateCode}
            </if>
        </where>
        
        <choose>
            <when test="sortType == 'PRICE_LOW'">
                ORDER BY P.PROD_PRICE ASC
            </when>
            <when test="sortType == 'PRICE_HIGH'">
                ORDER BY P.PROD_PRICE DESC
            </when>
            <when test="sortType == 'WISH_COUNT'"> ORDER BY P.WISH_COUNT DESC, P.REG_DATE DESC
            </when>
            <otherwise>
                ORDER BY P.REG_DATE DESC, P.PROD_ID DESC 
            </otherwise>
        </choose>
    </select>

    <select id="getProductInfo" parameterType="String" resultType="ProductDTO">
        SELECT 
            PROD_ID          as prodId,
            PROD_NAME        as prodName,
            PROD_DESC        as prodDesc,
            PROD_PRICE       as prodPrice,
            PROD_RATING      as prodRating,
            REVIEW_COUNT     as reviewCount,
            STOCK_COUNT      as stockCount,
            DETAIL_FILE_NAME as detailFileName,  -- 아까 추가한 통이미지 컬럼
            IMAGE_URL        as imageUrl,         -- 기본 경로
            FILE_NAME        as fileName
        FROM PRODUCT_MASTER
        WHERE PROD_ID = #{prodId}
    </select>

    <select id="getSliderImages" parameterType="String" resultType="ProductImgDTO">
        SELECT 
            IMG_ID        as imgId,
            FILE_PATH     as filePath,
            ORIGINAL_NAME as originalName,
            SORT_ORDER    as sortOrder
        FROM PRODUCT_IMG
        WHERE PROD_ID = #{prodId}
        AND IMG_TYPE = 'SLIDE'  -- 슬라이더용만 가져오기
        ORDER BY SORT_ORDER ASC
    </select>

    <update id="upsertCart" parameterType="CartDTO">
        MERGE INTO PRODUCT_CART c
        USING DUAL
        ON (c.USER_ID = #{userId} AND c.PROD_ID = #{prodId})
        WHEN MATCHED THEN
            UPDATE SET 
                REG_DATE = SYSDATE
                <if test="quantity != null">
                    , QUANTITY = c.QUANTITY + #{quantity}
                </if>
                <if test="checked != null">
                    , CHECKED = #{checked}
                </if>
        WHEN NOT MATCHED THEN
            INSERT (
                CART_SEQ, USER_ID, PROD_ID, PROD_NAME, PROD_PRICE, 
                PROD_DESC, QUANTITY, FILE_NAME, IMAGE_URL, CHECKED, REG_DATE
            ) VALUES (
                SEQ_CART_ID.NEXTVAL, #{userId}, #{prodId}, #{prodName, jdbcType=VARCHAR}, #{prodPrice, jdbcType=NUMERIC}, 
                #{prodDesc, jdbcType=VARCHAR}, #{quantity, jdbcType=NUMERIC}, #{fileName, jdbcType=VARCHAR}, #{imageUrl, jdbcType=VARCHAR}, 'Y', SYSDATE
            )
    </update>

    <update id="updateCart" parameterType="CartDTO">
        UPDATE PRODUCT_CART
        <set>
            <if test="quantity != null">
                QUANTITY = #{quantity},
            </if>
            <if test="checked != null">
                CHECKED = #{checked},
            </if>
        </set>
        WHERE USER_ID = #{userId} AND PROD_ID = #{prodId}
    </update>

    <select id="selectCartList" resultType="CartDTO" parameterType="String">
        SELECT 
            CART_SEQ   as cartSeq,
            USER_ID    as userId,
            PROD_ID    as prodId,
            PROD_NAME  as prodName,
            PROD_PRICE as prodPrice,
            PROD_DESC  as prodDesc,
            QUANTITY   as quantity,
            FILE_NAME  as fileName,
            IMAGE_URL  as imageUrl,
            CHECKED    as checked,
            REG_DATE   as regDate
        FROM PRODUCT_CART
        WHERE USER_ID = #{userId}
    </select>

    <delete id="deleteCart" parameterType="CartDTO">
        DELETE FROM PRODUCT_CART
        WHERE USER_ID = #{userId}
        --단건과 전체 삭제 구분을 위한 조건문
        <if test="prodId != null and prodId != ''">
            AND PROD_ID = #{prodId}
        </if>
    </delete>

    <insert id="insertWishList" parameterType="WishListDTO">
        INSERT INTO WISHLIST (
            WISH_ID,
            USER_ID,
            PROD_ID
        ) VALUES (
            SEQ_WISHLIST_ID.NEXTVAL,
            #{userId},
            #{prodId}
        )
    </insert>

    <delete id="deleteWishList" parameterType="WishListDTO">
        DELETE FROM WISHLIST 
        WHERE USER_ID = #{userId}
        <if test="prodId != null and prodId != ''">
            AND PROD_ID = #{prodId}
        </if>
    </delete>
</mapper>